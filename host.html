<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GridBuzzer - è€å¸«æ§åˆ¶å°</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            padding: 20px;
            gap: 20px;
        }
        
        .controls,
        .logs {
            min-width: 300px;
        }
        
        #grid-container {
            display: grid;
            border: 1px solid #ccc;
        }
        
        .grid-cell {
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #eee;
            background-color: #f0f0f0;
            color: #aaa;
        }
        
        .grid-cell.connected {
            background-color: #d0e0ff;
            color: #333;
        }
        
        .grid-cell.active {
            background-color: #a0f0a0;
            border: 2px solid green;
        }
        
        .grid-cell.locked {
            background-color: #ffc0c0;
        }
        
        #log-valid,
        #log-invalid {
            height: 300px;
            border: 1px solid #ccc;
            overflow-y: auto;
            padding: 5px;
        }
        
        h3 {
            margin-top: 0;
        }
        
        button {
            font-size: 16px;
            padding: 8px;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="main-grid">
        <h2>åº§ä½åœ–</h2>
        <div id="grid-container"></div>
    </div>

    <div class="controls">
        <h2>æ§åˆ¶é¢æ¿</h2>
        <div>
            <label>æ©«æ’(Rows): <input type="number" id="txtRows" value="6"></label>
            <label>ç›´æ’(Cols): <input type="number" id="txtCols" value="7"></label>
            <button id="btnCreateGame">å»ºç«‹éŠæˆ² (é‡è¨­)</button>
        </div>
        <hr>
        <div>
            <select id="selectMode">
                <option value="all">å…¨å“¡æ¶ç­”</option>
                <option value="cross">å¤§åå­—</option>
                <option value="square">ä¹å®®æ ¼</option>
            </select>
            <button id="btnDrawNumber">æŠ½è™Ÿä¸¦é–‹å§‹</button>
            <h3 id="lastDrawn">æŠ½ä¸­: -</h3>
        </div>
        <hr>
        <button id="btnReset">æ¸…é™¤æŒ‰éˆ´ (å•ä¸‹ä¸€é¡Œ)</button>
    </div>

    <div class="logs">
        <h3>ğŸŸ¢ æœ‰æ•ˆæ¶ç­”</h3>
        <div id="log-valid"></div>
        <h3>ğŸ”´ é•è¦/ç¦ç­”</h3>
        <div id="log-invalid"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let layout = {
            rows: 0,
            cols: 0
        };
        const gridContainer = document.getElementById('grid-container');
        const logValid = document.getElementById('log-valid');
        const logInvalid = document.getElementById('log-invalid');

        // --- ç¹ªè£½ç¶²æ ¼ ---
        function drawGrid() {
            layout.rows = parseInt(document.getElementById('txtRows').value);
            layout.cols = parseInt(document.getElementById('txtCols').value);
            gridContainer.innerHTML = '';
            gridContainer.style.gridTemplateColumns = `repeat(${layout.cols}, 60px)`;

            for (let i = 1; i <= layout.rows * layout.cols; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.id = `seat-${i}`;
                cell.innerText = i;
                gridContainer.appendChild(cell);
            }
        }

        // --- äº‹ä»¶ç›£è½ ---
        document.getElementById('btnCreateGame').onclick = () => {
            drawGrid();
            socket.emit('host:createGame', layout);
            logValid.innerHTML = '';
            logInvalid.innerHTML = '';
            document.getElementById('lastDrawn').innerText = 'æŠ½ä¸­: -';
        };

        document.getElementById('btnDrawNumber').onclick = () => {
            const total = layout.rows * layout.cols;
            if (total === 0) {
                alert('è«‹å…ˆå»ºç«‹éŠæˆ²');
                return;
            }
            const mode = document.getElementById('selectMode').value;
            const targetNumber = Math.floor(Math.random() * total) + 1;

            document.getElementById('lastDrawn').innerText = `æŠ½ä¸­: ${targetNumber}`;
            logValid.innerHTML = '';
            logInvalid.innerHTML = '';

            socket.emit('host:setMode', {
                mode: mode,
                target: targetNumber
            });
        };

        document.getElementById('btnReset').onclick = () => {
            logValid.innerHTML = '';
            logInvalid.innerHTML = '';
            socket.emit('host:reset');
            // é‡è¨­ç¶²æ ¼é¡è‰²
            const cells = document.querySelectorAll('.grid-cell.active, .grid-cell.locked');
            cells.forEach(c => c.classList.remove('active', 'locked'));
            // é‡æ–°ç™¼é€æ¨¡å¼ï¼Œä»¥ä¾¿å­¸ç”Ÿç«¯é‡è¨­
            const target = parseInt(document.getElementById('lastDrawn').innerText.split(': ')[1]);
            if (target) {
                const mode = document.getElementById('selectMode').value;
                socket.emit('host:setMode', {
                    mode: mode,
                    target: target
                });
            }
        };

        // --- Socket äº‹ä»¶ ---
        socket.on('host:playerJoined', (seat) => {
            document.getElementById(`seat-${seat}`) ? .classList.add('connected');
        });

        socket.on('host:playerLeft', (seat) => {
            document.getElementById(`seat-${seat}`) ? .classList.remove('connected', 'active', 'locked');
        });

        socket.on('host:updateGridState', ({
            active,
            locked
        }) => {
            // å…ˆæ¸…é™¤èˆŠç‹€æ…‹
            document.querySelectorAll('.grid-cell').forEach(c => c.classList.remove('active', 'locked'));
            // è¨­å®šæ–°ç‹€æ…‹
            active.forEach(seat => document.getElementById(`seat-${seat}`) ? .classList.add('active'));
            locked.forEach(seat => document.getElementById(`seat-${seat}`) ? .classList.add('locked'));
        });

        socket.on('host:logBuzz', ({
            seat,
            valid,
            time
        }) => {
            const logEntry = document.createElement('div');
            logEntry.innerText = `åº§è™Ÿ ${seat} (${time % 10000}ms)`;

            if (valid) {
                logValid.prepend(logEntry);
            } else {
                logInvalid.prepend(logEntry);
            }
        });

        // é é¢è¼‰å…¥æ™‚å…ˆç•«ä¸€æ¬¡
        drawGrid();
    </script>
</body>

</html>